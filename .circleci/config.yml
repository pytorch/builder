version: 2.1

# Define the jobs we want to run for this project
jobs:
  build:
    docker:
      - image: pytorch/manylinux-builder:cpu
    resource_class: 2xlarge+
    steps:
      - checkout
      - run:
          name: "Checking out PyTorch"
          command: |   
            git clone --depth 1 https://github.com/pytorch/pytorch /home/circleci/project/pytorch
            export PACKAGE_TYPE=manywheel
            export DESIRED_CUDA=cpu
            export DESIRED_PYTHON=3.7m
            export DESIRED_DEVTOOLSET=devtoolset7
            MEMORY_LIMIT_MAX_JOBS=18
            NUM_CPUS=$(( $(nproc) - 2 )) 
            export MAX_JOBS=${MAX_JOBS:-$(( ${NUM_CPUS} > ${MEMORY_LIMIT_MAX_JOBS} ? ${MEMORY_LIMIT_MAX_JOBS} : ${NUM_CPUS} ))}
            bash manywheel/build_cpu.sh
  # test:
  #   docker:
  #     - image: circleci/python:3.7
  #   steps:
  #     - checkout
  #     - run: echo "this is the test job"

# Orchestrate our job run sequence
workflows:
  build_and_test:
    jobs:
      - build
    #  - test
